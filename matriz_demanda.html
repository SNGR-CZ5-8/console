<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Matriz de Demanda de Servicios</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root{
      --brand:#2F338F; --bg:#f4f6f9; --ink:#333; --line:#e6e9f3;
      --card:#fff; --muted:#6b7280;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 'Roboto',system-ui,Segoe UI,Arial,sans-serif;padding-bottom:72px}

    /* HEADER */
    header{background:var(--brand);color:#fff;text-align:center;padding:1.7rem 1rem;box-shadow:0 2px 8px rgba(0,0,0,.15)}
    header .wrap{max-width:1100px;margin:0 auto}
    header img{max-height:70px;display:block;margin:0 auto .6rem}
    header h1{font-size:1.9rem;font-weight:700;margin:0}
    header p{font-size:.95rem;opacity:.9;margin-top:.25rem}

    /* CARD */
    .container{max-width:1100px;margin:2rem auto;background:var(--card);padding:2rem;border-radius:18px;border:1px solid var(--line);box-shadow:0 8px 20px rgba(0,0,0,.08)}
    h2{margin:0 0 1.1rem;text-align:center;color:var(--brand);font-size:1.6rem}
    .sub{color:var(--muted);text-align:center;margin:-.35rem 0 1.1rem}

    /* FORM */
    form{display:grid;grid-template-columns:1fr 1fr;gap:1rem 1.5rem}
    .field{display:flex;flex-direction:column}
    .full{grid-column:1/-1}
    label{font-size:.95rem;color:#4b5563;margin:0 0 .35rem 2px}
    input,select,textarea{width:100%;padding:12px 14px;border:1px solid #cfd4e1;border-radius:12px;font-size:1rem;transition:border-color .2s,box-shadow .2s}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(47,51,143,.12)}
    textarea{resize:vertical;min-height:70px}

    /* ACTIONS */
    .actions{grid-column:1/-1;display:flex;gap:.75rem;justify-content:flex-end;margin-top:.5rem}
    .btn{background:var(--brand);color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#eef2ff;color:var(--brand);border:1px solid #c7ccff}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* FOOTER */
    footer{position:fixed;left:0;bottom:0;width:100%;background:var(--brand);color:#fff;text-align:center;padding:.85rem;font-size:.9rem;box-shadow:0 -2px 8px rgba(0,0,0,.12)}

    @media (max-width:860px){ form{grid-template-columns:1fr} }
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <img src="Logo el NUEVO ECUADOR.png" alt="El Nuevo Ecuador">
    <h1>Secretaría Nacional de Gestión de Riesgos</h1>
    <p>Coordinación Zonal 5-8 | Uso Interno y Personal</p>
  </div>
</header>

<main class="container">
  <h2>Matriz de Demanda de Servicios</h2>
  <div class="sub">“Servicio”, “Producto” y “Tiempo establecido” se autocompletan según el Trámite.</div>

  <form id="formulario" onsubmit="enviarFormulario(event)" autocomplete="off" novalidate>
    <div class="field full">
      <label for="tramite">Trámite</label>
      <select id="tramite" name="tramite" onchange="autocompletar()" required>
        <option value="">Seleccione un trámite</option>
      </select>
    </div>

    <div class="field">
      <label>Servicio</label>
      <input id="servicio" name="servicio" readonly required>
    </div>

    <div class="field">
      <label>Producto</label>
      <input id="producto" name="producto" readonly required>
    </div>

    <div class="field">
      <label>Fecha y hora de solicitud</label>
      <input type="datetime-local" id="fechaSolicitud" name="fechaSolicitud" required>
    </div>

    <div class="field">
      <label>Fecha y hora de entrega</label>
      <input type="datetime-local" id="fechaEntrega" name="fechaEntrega" required>
    </div>

    <div class="field">
      <label>Tiempo de atención (días hábiles)</label>
      <input id="tiempoAtencion" name="tiempoAtencion" readonly required>
    </div>

    <div class="field">
      <label>Tiempo establecido (días)</label>
      <input id="tiempoEstablecido" name="tiempoEstablecido" readonly required>
    </div>

    <div class="field full">
      <label>Resultado</label>
      <input id="cumple" name="cumple" readonly required>
    </div>

    <div class="field">
      <label>Tipo de usuario / Beneficiario</label>
      <select id="tipoUsuario" required>
        <option value="">Seleccione</option>
        <option>EXTERNO</option>
        <option>INTERNO</option>
      </select>
    </div>

    <div class="field">
      <label>Canal de acceso</label>
      <select id="canalAcceso" required>
        <option value="">Seleccione</option>
        <option>Planificado (solo servicios sin trámite)</option>
        <option>Presencial</option>
        <option>No presencial (Correo electrónico, Quipux, Contacto Ciudadano, GOB.EC)</option>
        <option>Virtual (App web) – solo Capacitación Virtual</option>
      </select>
    </div>

    <div class="field">
      <label>Nombre del requirente / Razón social</label>
      <input id="requirente" required>
    </div>

    <div class="field">
      <label>Contacto</label>
      <input id="contacto" placeholder="Teléfono / correo" required>
    </div>

    <div class="field full">
      <label>Propósito del servicio</label>
      <textarea id="proposito" rows="2" required></textarea>
    </div>

    <div class="field full">
      <label>Observaciones</label>
      <textarea id="observaciones" rows="2"></textarea>
    </div>

    <div class="field full">
      <label>Técnico responsable del trámite</label>
      <input id="tecnico" required>
    </div>

    <div class="actions">
      <button type="button" class="btn secondary" id="btnLimpiar">Limpiar</button>
      <button type="submit" class="btn" id="btnEnviar">Enviar formulario</button>
    </div>
  </form>
</main>

<footer>© 2025 Secretaría Nacional de Gestión de Riesgos – CZ 5-8 | Uso Interno</footer>

<!-- IFRAME (solo si se usa el fallback a Google Forms) -->
<iframe name="dummyFrame" style="display:none"></iframe>

<script>
/* ================================
   CONFIG DE ENVÍO
   ================================ */
// Intenta primero sin action y luego con action=save (para compatibilidad)
const WORKER_ENDPOINTS = [
  "https://white-night-b8de.dylanvillasagua.workers.dev/certificados",
  "https://white-night-b8de.dylanvillasagua.workers.dev/certificados?action=save"
];

// Si quieres desactivar el respaldo a Google Forms, pon false
const FALLBACK_TO_FORMS = true;

// (Respaldo) URL del Google Forms actual
const GOOGLE_FORM_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSfz-2g5cH9E5wDEzX_LUZQ2EpBSsrWiagTHrRZQHwE1W_Emcg/formResponse";

/* ================================
   BASE DE DATOS LOCAL (Trámite → Servicio/Producto/Tiempo)
   ================================ */
const baseDatos = {
  "Emisión de informe de análisis de amenaza o inspección técnica para la reducción del riesgo del desastres": {
    servicio:"Análisis de amenaza o riesgo aceptable para la reducción del riesgo de desastres",
    producto:"Informe de análisis de amenaza o Informe de inspección técnica",
    tiempo:"30"
  },
  "Emisión de informe de estimación del riesgo aceptable para la reducción del riesgo de desastres": {
    servicio:"Análisis de amenaza o riesgo aceptable para la reducción del riesgo de desastres",
    producto:"Informe de estimación del riesgo aceptable",
    tiempo:"30"
  },
  "Atención a requerimientos de información para la gestión del riesgo de desastres": {
    servicio:"Acceso a la información para la gestión del riesgo de desastres",
    producto:"Información histórica de afectaciones por eventos peligrosos o Información espacial de gestión de riesgos de desastres",
    tiempo:"15"
  },
  "Atención a requerimientos de capacitación en gestión del riesgo de desastres para grupos de interés": {
    servicio:"Capacitación en gestión del riesgo de desastres",
    producto:"Certificado de Capacitación en gestión de riesgos",
    tiempo:"15"
  },
  "Inscripción en cursos virtuales de capacitación en gestión del riesgo de desastres": {
    servicio:"Capacitación en gestión del riesgo de desastres",
    producto:"Certificado de Capacitación en gestión de riesgos",
    tiempo:"30"
  },
  "Atención a requerimientos de Asistencia técnica para la creación o fortalecimiento de la Unidad de Gestión de Riesgos": {
    servicio:"Asistencia técnica para la creación o fortalecimiento de la Unidad de Gestión de Riesgos",
    producto:"Informe de asistencia técnica para la creación o fortalecimiento de la Unidad de Gestión de Riesgos",
    tiempo:"15"
  },
  "Asistencia técnica para la creación o fortalecimiento de la Unidad de Gestión de Riesgos - Sin trámite": {
    servicio:"Asistencia técnica para la creación o fortalecimiento de la Unidad de Gestión de Riesgos",
    producto:"Informe de asistencia técnica para la creación o fortalecimiento de la Unidad de Gestión de Riesgos",
    tiempo:"15"
  },
  "Asistencia técnica para la conformación o fortalecimiento de los Comités Comunitarios de Gestión de Riesgos - Sin trámite": {
    servicio:"Asistencia técnica para la conformación o fortalecimiento de los Comités Comunitarios de Gestión de Riesgos",
    producto:"Plan comunitario de gestión de riesgos socializado en asamblea comunitaria",
    tiempo:"45"
  },
  "Atención a requerimientos de sensibilización en prevención del riesgo de desastres": {
    servicio:"Sensibilización en prevención del riesgo de desastres",
    producto:"Evento de sensibilización en prevención del riesgo de desastres cumplido",
    tiempo:"15"
  },
  "Sensibilización en prevención del riesgo de desastres - Sin trámite": {
    servicio:"Sensibilización en prevención del riesgo de desastres",
    producto:"Evento de sensibilización en prevención del riesgo de desastres cumplido",
    tiempo:"15"
  },
  "Atención a requerimientos de asesoría técnica para la implementación de instrumentos normativos y metodológicos para la reducción del riesgo de desastres": {
    servicio:"Asesoría técnica para la implementación de instrumentos normativos y metodológicos para la reducción del riesgo de desastres",
    producto:"Informe de cumplimiento a la asesoría técnica",
    tiempo:"15"
  },
  "Asesoría técnica para la implementación  de instrumentos normativos y metodológicos para la respuesta ante emergencias y/o desastres - Sin trámite": {
    servicio:"Asesoría técnica para la implementación de instrumentos normativos y metodológicos para la respuesta ante emergencias y/o desastres",
    producto:"Informe técnico de respuesta",
    tiempo:"60"
  },
  "Atención a requerimientos de asesoría técnica para la implementación de simulaciones y simulacros por eventos peligrosos relacionados con la gestión del riesgo de desastres": {
    servicio:"Asesoría técnica para simulaciones y simulacros",
    producto:"Herramienta metodológica + recomendaciones de uso",
    tiempo:"15"
  },
  "Atención a requerimientos de asistencia humanitaria en situaciones de emergencia": {
    servicio:"Asistencia humanitaria en situaciones de emergencia",
    producto:"Entrega de bienes de asistencia humanitaria",
    tiempo:"5"
  },
  "Atención a requerimientos de participación del voluntariado de protección civil en eventos de concentración masiva": {
    servicio:"Participación del voluntariado de protección civil",
    producto:"Participación del voluntariado en el evento",
    tiempo:"15"
  },
  "Participación del voluntariado de protección civil para la gestión del riesgo de desastres - Sin trámites": {
    servicio:"Participación del voluntariado de protección civil",
    producto:"Participación del voluntariado en el evento peligroso",
    tiempo:"15"
  },
  "Inscripción para ingreso al Voluntariado de Protección Civil del Servicio Nacional de Gestión de Riesgos y Emergencias": {
    servicio:"Captación y formación del Voluntariado de Protección Civil",
    producto:"Certificado de formación en protección civil",
    tiempo:"15"
  },
  "Calificación de alojamientos temporales para la operación en emergencias - Sin trámite": {
    servicio:"Calificación de alojamientos temporales para la operación en emergencias",
    producto:"Calificación de alojamientos temporales",
    tiempo:"3"
  },
  "Atención a requerimientos de acompañamiento técnico para el manejo de alojamientos temporales en emergencias": {
    servicio:"Acompañamiento técnico para el manejo de alojamientos temporales",
    producto:"Informe de acompañamiento técnico",
    tiempo:"15"
  },
  "Atención a requerimientos de información de amenazas por eventos peligrosos y eventos peligrosos en curso": {
    servicio:"Acceso a la Información de amenazas naturales y eventos peligrosos en curso",
    producto:"Información de gestión de riesgos solicitada",
    tiempo:"15"
  },
  "Aprobación del estatuto y otorgamiento de la personalidad jurídica como Organizacion Social en Gestión de Riesgos": {
    servicio:"Legalización de organizaciones sociales en gestión de riesgos",
    producto:"Documento jurídico de aprobación",
    tiempo:"15"
  },
  "Reforma de estatutos de Organizaciones Sociales en Gestión de Riesgos": {
    servicio:"Legalización de organizaciones sociales en gestión de riesgos",
    producto:"Documento jurídico de reforma de estatutos",
    tiempo:"15"
  },
  "Atención a requerimientos de inclusión y exclusión de miembros de las organizaciones sociales en gestión de riesgos": {
    servicio:"Legalización de organizaciones sociales en gestión de riesgos",
    producto:"Documento jurídico de inclusión y exclusión",
    tiempo:"15"
  },
  "Atención a requerimientos de registro de directiva de organizaciones sociales en gestión de riesgos": {
    servicio:"Legalización de organizaciones sociales en gestión de riesgos",
    producto:"Documento jurídico de registro de directiva",
    tiempo:"15"
  },
  "Atención a requerimientos de disolución y liquidación voluntaria de organizaciones sociales en gestión de riesgos": {
    servicio:"Legalización de organizaciones sociales en gestión de riesgos",
    producto:"Documento jurídico de disolución y liquidación voluntaria",
    tiempo:"15"
  },
  "Atención de requerimientos de acceso a la información pública de la Secretaría de Gestión de Riesgos": {
    servicio:"Acceso a la información pública de la Secretaría de Gestión de Riesgos",
    producto:"Información pública en el marco del artículo 7 de la LOTAIP",
    tiempo:"15"
  }
};

/* ===== Init ===== */
window.addEventListener('DOMContentLoaded', () => {
  const sel = document.getElementById('tramite');
  Object.keys(baseDatos).forEach(t => {
    const o = document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o);
  });
  document.getElementById('fechaSolicitud').addEventListener('change', calcularTiempo);
  document.getElementById('fechaEntrega').addEventListener('change', calcularTiempo);
  document.getElementById('btnLimpiar').addEventListener('click', ()=>{ document.getElementById('formulario').reset(); clearAuto(); });
});

/* ===== Autocompletar ===== */
function autocompletar(){
  const t = document.getElementById('tramite').value;
  const d = baseDatos[t];
  if (d){
    document.getElementById('servicio').value = d.servicio;
    document.getElementById('producto').value = d.producto;
    document.getElementById('tiempoEstablecido').value = d.tiempo;
    calcularTiempo();
  }else{
    clearAuto();
  }
}
function clearAuto(){
  ['servicio','producto','tiempoEstablecido','tiempoAtencion','cumple'].forEach(id=> document.getElementById(id).value='');
}

/* ===== Días hábiles ===== */
function contarDiasLaborables(inicio, fin){
  try{
    let a=new Date(inicio), b=new Date(fin), c=0;
    if (isNaN(a)||isNaN(b)) return 0;
    a=new Date(a.getFullYear(),a.getMonth(),a.getDate());
    b=new Date(b.getFullYear(),b.getMonth(),b.getDate());
    while(a<=b){ const d=a.getDay(); if(d!==0 && d!==6) c++; a.setDate(a.getDate()+1); }
    return c;
  }catch{ return 0; }
}
function calcularTiempo(){
  const ini=document.getElementById('fechaSolicitud').value;
  const fin=document.getElementById('fechaEntrega').value;
  if (!ini || !fin){ document.getElementById('tiempoAtencion').value=''; document.getElementById('cumple').value='Pendiente'; return; }
  const dias = contarDiasLaborables(ini, fin);
  document.getElementById('tiempoAtencion').value = dias;
  const est = parseInt(document.getElementById('tiempoEstablecido').value||'0',10);
  document.getElementById('cumple').value = est ? (dias<=est ? 'Cumple':'No Cumple') : 'Pendiente';
}

/* ================================
   ENVÍO: Worker (primario) + Forms (respaldo opcional)
   ================================ */
async function enviarFormulario(e){
  e.preventDefault();
  const btn = document.getElementById('btnEnviar');
  btn.disabled = true;

  const oblig = ["tramite","servicio","producto","fechaSolicitud","fechaEntrega","tipoUsuario","canalAcceso","requirente","contacto","proposito","tecnico"];
  const falt = oblig.filter(id => !String(document.getElementById(id).value||"").trim());
  if (falt.length){
    btn.disabled = false;
    Swal.fire("Falta información","Completa: "+falt.join(", "),"warning");
    return;
  }

  const payload = {
    tramite:  document.getElementById("tramite").value,
    servicio: document.getElementById("servicio").value,
    producto: document.getElementById("producto").value,
    fechaSolicitud: document.getElementById("fechaSolicitud").value,
    fechaEntrega:   document.getElementById("fechaEntrega").value,
    tiempoEstablecido: document.getElementById("tiempoEstablecido").value,
    cumple: document.getElementById("cumple").value || "",
    tipoUsuario: document.getElementById("tipoUsuario").value,
    canalAcceso: document.getElementById("canalAcceso").value,
    requirente:  document.getElementById("requirente").value,
    contacto:    document.getElementById("contacto").value,
    proposito:   document.getElementById("proposito").value,
    observaciones: document.getElementById("observaciones").value,
    tecnico:     document.getElementById("tecnico").value,
    ua: navigator.userAgent
  };

  // 1) Intento con el Worker (prueba ambas variantes)
  try{
    const js = await postToWorker(payload);
    await Swal.fire("Guardado", `Registro #${js.id} creado`, "success");
    document.getElementById('formulario').reset(); clearAuto();
    btn.disabled = false;
    return;
  }catch(errWorker){
    console.warn("Worker falló:", errWorker);
  }

  // 2) Respaldo opcional a Google Forms
  if (FALLBACK_TO_FORMS){
    try{
      postToGoogleForms(); // no lanza CORS por iframe
      await Swal.fire({icon:'success',title:'Formulario enviado',text:'Los datos han sido registrados correctamente (respaldo).'});
      document.getElementById('formulario').reset(); clearAuto();
      btn.disabled = false;
      return;
    }catch(errForms){
      console.error("Forms falló:", errForms);
    }
  }

  // 3) Si todo falla
  btn.disabled = false;
  Swal.fire("Error","No se pudo registrar. Verifica el Worker y vuelve a intentar.","error");
}

async function postToWorker(data){
  // intenta /certificados y luego /certificados?action=save
  let lastErr;
  for (const url of WORKER_ENDPOINTS){
    try{
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      const js = await res.json().catch(()=> ({}));
      if (res.ok && js && js.ok) return js;
      // si devuelve INVALID... intenta la otra variante
      lastErr = new Error(js?.error || `HTTP ${res.status}`);
    }catch(e){
      lastErr = e;
    }
  }
  throw lastErr || new Error("No se pudo contactar al Worker");
}

function postToGoogleForms(){
  const fs = document.getElementById("fechaSolicitud").value||"", fe = document.getElementById("fechaEntrega").value||"";
  const [fsDate,fsTime] = fs.split("T"); const [feDate,feTime] = fe.split("T");
  const [fsY="00",fsM="00",fsD="00"]=(fsDate||"").split("-"); const [fsH="00",fsMin="00"]=(fsTime||"").split(":");
  const [feY="00",feM="00",feD="00"]=(feDate||"").split("-"); const [feH="00",feMin="00"]=(feTime||"").split(":");

  const campos = {
    "entry.1959236414": document.getElementById("tramite").value,
    "entry.877888232":  document.getElementById("servicio").value,
    "entry.1047749455": document.getElementById("producto").value,

    "entry.479612767_year":fsY, "entry.479612767_month":fsM, "entry.479612767_day":fsD,
    "entry.479612767_hour":fsH||"00", "entry.479612767_minute":fsMin||"00",

    "entry.371310726_year":feY, "entry.371310726_month":feM, "entry.371310726_day":feD,
    "entry.371310726_hour":feH||"00", "entry.371310726_minute":feMin||"00",

    "entry.235301614": document.getElementById("tiempoAtencion").value,
    "entry.764566110": document.getElementById("tiempoEstablecido").value,
    "entry.2016087422": document.getElementById("cumple").value,
    "entry.1411334318": document.getElementById("tipoUsuario").value,
    "entry.5168654":    document.getElementById("canalAcceso").value,
    "entry.231186390":  document.getElementById("requirente").value,
    "entry.318606261":  document.getElementById("contacto").value,
    "entry.344676128":  document.getElementById("proposito").value,
    "entry.1419064653": document.getElementById("observaciones").value,
    "entry.1752369747": document.getElementById("tecnico").value
  };

  const form = document.createElement("form");
  form.action = GOOGLE_FORM_ACTION; form.method = "POST"; form.target = "dummyFrame";
  for (const k in campos){
    const i = document.createElement("input");
    i.type="hidden"; i.name=k; i.value=campos[k]??"";
    form.appendChild(i);
  }
  document.body.appendChild(form); form.submit(); form.remove();
}
</script>
</body>
</html>
