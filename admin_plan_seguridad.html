<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Administración de Certificados</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  :root{
    --brand:#2F338F;
    --ink:#111827;
    --muted:#6b7280;
    --line:#e5e7eb;
    --bg:#f5f6fb;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.35 "Inter",system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

  /* NAV (única barra) */
  .nav{position:sticky;top:0;z-index:10;background:var(--brand);color:#fff;box-shadow:0 2px 10px rgba(17,24,39,.15)}
  .nav .bar{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:.65rem 1rem}
  .nav .brand{font-weight:700;letter-spacing:.2px}
  .nav .links{margin-left:auto;display:flex;gap:.25rem}
  .nav a{color:#fff;text-decoration:none;padding:.45rem .65rem;border-radius:10px}
  .nav a:hover{background:rgba(255,255,255,.12)}

  /* WRAP */
  .wrap{max-width:1200px;margin:18px auto;padding:0 14px}

  /* HERO compacto (no es barra) */
  .hero{background:var(--brand);color:#fff;border-radius:16px;padding:14px 18px;display:flex;align-items:center;gap:16px;box-shadow:0 10px 30px rgba(17,24,39,.08);margin-bottom:14px}
  .hero img{height:52px;width:auto}
  .hero .txt{line-height:1.2}
  .hero .title{font-size:1.55rem;font-weight:800;margin:0}
  .hero .sub{font-size:.95rem;opacity:.95;margin-top:2px}

  /* PANEL */
  .panel{background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(17,24,39,.06)}
  .title{font-size:1.15rem;font-weight:700;color:var(--brand);margin:6px 2px 14px}

  /* KPIs */
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
  .kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
  .kpi h4{margin:0 0 6px;font-weight:600;color:#374151}
  .kpi .num{font-size:1.35rem;font-weight:700}

  /* Toolbar */
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 12px}
  input,select,button{font:14px "Inter",sans-serif;border:1px solid #cfd4e1;border-radius:10px;padding:9px 11px}
  input[type="search"]{min-width:260px;flex:1}
  button{background:var(--brand);color:#fff;font-weight:700;border:none;cursor:pointer}
  button.secondary{background:#eef2ff;color:var(--brand);border:1px solid #c7ccff}
  button.icon{background:#fff;color:var(--brand);border:1px solid #c7ccff;padding:6px 8px;display:inline-flex;align-items:center;justify-content:center}
  button.icon svg{width:16px;height:16px}
  button.small{padding:7px 10px}

  /* Tabla */
  .grid{overflow:auto;border:1px solid var(--line);border-radius:14px}
  table{width:100%;border-collapse:collapse;background:#fff}
  th,td{padding:9px 10px;border-bottom:1px solid #f0f1f4;vertical-align:middle;white-space:nowrap}
  th{background:#f9fafb;text-align:left;position:sticky;top:0;z-index:1}
  tr:hover td{background:#fafafa}
  .clip{max-width:260px;overflow:hidden;text-overflow:ellipsis}
  .pill{padding:2px 7px;border-radius:999px;font-size:.78rem}
  .ok{background:#e8fff0;color:#065f46}.bad{background:#fee2e2;color:#991b1b}

  /* Editor */
  .layout{display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-top:14px}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
  label{display:block;font-size:.9rem;color:#4b5563;margin-bottom:4px}
  .muted{color:var(--muted)}

  /* FOOTER */
  .foot{margin-top:20px;background:var(--brand);color:#fff;text-align:center;padding:14px;border-radius:14px}

  @media (max-width:1000px){
    .layout{grid-template-columns:1fr}
    .row{grid-template-columns:1fr}
    .kpis{grid-template-columns:1fr}
    .hero{padding:12px 14px}
    .hero img{height:44px}
    .hero .title{font-size:1.3rem}
    .hero .sub{font-size:.88rem}
  }
</style>
</head>
<body>

<!-- NAV ÚNICA -->
<nav class="nav">
  <div class="bar">
    <div class="brand">Administración de Certificados</div>
    <div class="links">
      <a href="index.html">Inicio</a>
      <a href="plan_seguridad.html">Certificados</a>
    </div>
  </div>
</nav>

<div class="wrap">

  <!-- HERO compacto (no menú) -->
  <section class="hero" aria-label="Encabezado institucional">
    <img src="Logo el NUEVO ECUADOR.png" alt="El Nuevo Ecuador">
    <div class="txt">
      <h1 class="title">Coordinación Zonal 5-8 | Uso Interno y Personal</h1>
      <div class="sub">Secretaría Nacional de Gestión de Riesgos</div>
    </div>
  </section>

  <div class="panel">
    <div class="title">Listado</div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi"><h4>Total</h4><div class="num" id="k_total">-</div></div>
      <div class="kpi"><h4>Aprobados</h4><div class="num" id="k_ok">-</div></div>
      <div class="kpi"><h4>Rechazados</h4><div class="num" id="k_bad">-</div></div>
    </div>

    <!-- Herramientas -->
    <div class="toolbar">
      <input id="q" type="search" placeholder="Buscar (n° trámite, evento, solicitante, ciudad…)">
      <select id="orderBy">
        <option value="N° de Trámite" selected>N° de Trámite</option>
        <option value="Fecha de Emisión">Fecha de Emisión</option>
        <option value="Evento Deportivo">Evento</option>
        <option value="Presentado por">Presentado por</option>
        <option value="Estado del Trámite">Estado</option>
      </select>
      <select id="dir"><option value="desc" selected>Desc</option><option value="asc">Asc</option></select>
      <select id="ps"><option>10</option><option selected>20</option><option>50</option><option>100</option></select>
      <button id="refresh" class="small">Actualizar</button>
      <button id="sync" class="secondary small" title="Sincroniza correlativo del formulario">Sincronizar correlativo</button>
    </div>

    <!-- TABLA exacta -->
    <div class="grid">
      <table>
        <thead>
          <tr>
            <th>N° Trámite</th>
            <th class="clip">Evento</th>
            <th class="clip">Presentado por</th>
            <th>Cédula</th>
            <th>Fecha Emisión</th>
            <th>Estado</th>
            <th>PDF</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8" style="text-align:center">Cargando…</td></tr>
        </tbody>
      </table>
    </div>

    <!-- EDITOR -->
    <div class="layout">
      <div class="card">
        <div class="title">Editar registro</div>
        <div id="editInfo" class="muted">Selecciona una fila para editar.</div>
        <div id="editForm" style="display:none;">
          <div class="row">
            <div><label>Evento Deportivo</label><input id="f_evento" placeholder="Evento Deportivo"></div>
            <div><label>Presentado por</label><input id="f_presentadoPor" placeholder="Presentado por"></div>
          </div>
          <div class="row">
            <div><label>Cédula de Identidad</label><input id="f_cedula" placeholder="Cédula"></div>
            <div><label>Lugar del Evento</label><input id="f_lugar" placeholder="Lugar"></div>
          </div>
          <div class="row">
            <div><label>Ciudad</label><input id="f_ciudad" placeholder="Ciudad"></div>
            <div><label>Provincia</label><input id="f_provincia" placeholder="Provincia"></div>
          </div>
          <div class="row">
            <div><label>Fecha del Evento</label><input type="date" id="f_fechaEvento"></div>
            <div><label>Hora Inicio</label><input type="time" id="f_horaInicio"></div>
          </div>
          <div class="row">
            <div><label>Hora Fin</label><input type="time" id="f_horaFin"></div>
            <div><label>Aforo</label><input type="number" id="f_aforo" min="0" step="1" placeholder="0"></div>
          </div>
          <div class="row">
            <div>
              <label>Estado del Trámite</label>
              <select id="f_estado">
                <option value="">(vacío)</option>
                <option value="Aprobado">Aprobado</option>
                <option value="Rechazado">Rechazado</option>
              </select>
            </div>
            <div><label>Fecha de Emisión</label><input type="date" id="f_fechaEmision"></div>
          </div>
          <div class="row">
            <div><label>URL PDF (opcional)</label><input id="f_PdfUrl" placeholder="https://…"></div>
            <div><label>Observaciones (opcional)</label><input id="f_Observaciones" placeholder="Observaciones"></div>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
            <button id="btnCancelar" class="secondary">Cancelar</button>
            <button id="save">Guardar cambios</button>
            <button id="deleteBtn" class="secondary">Eliminar registro</button>
          </div>
        </div>
      </div>

      <div class="card" id="ayuda">
        <div class="title">Ayuda</div>
        <div class="muted">
          Este panel consume el WebApp/Worker:<br>
          • Admin: <code>/panel?action=…</code><br>
          • Sync: <code>/?action=sync</code>
        </div>
      </div>
    </div>
  </div>

  <!-- PIE DE PÁGINA -->
  <footer class="foot">
    © 2025 Secretaría Nacional de Gestión de Riesgos – Coordinación Zonal 5-8
  </footer>
</div>

<script>
/* ====== CONFIG API ====== */
const API_PANEL = "https://white-night-b8de.dylanvillasagua.workers.dev/panel"; // admin
const API_FORM  = "https://white-night-b8de.dylanvillasagua.workers.dev/";      // sync

/* ====== STATE & HELPERS ====== */
const $ = (id)=>document.getElementById(id);
const state = { page:1, ps:20, q:'', orderBy:'N° de Trámite', dir:'desc', selected:null, pdfHeader:null };

function safe(v){ return (v===undefined||v===null)?'':String(v); }
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} }
function badge(s){ return (String(s||'').toLowerCase()==='aprobado')?'<span class="pill ok">Aprobado</span>':'<span class="pill bad">Rechazado</span>'; }
function icon(name){
  const map={
    edit:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>',
    open:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 3h7v7"/><path d="M10 14L21 3"/><path d="M5 5v14h14"/></svg>',
    refresh:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 12a9 9 0 1 1-3-6.7"/><path d="M21 3v7h-7"/></svg>',
    trash:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M19 6l-1 14H6L5 6"/></svg>'
  };
  return map[name]||'';
}

/* ====== UI EVENTS ====== */
$('ps').addEventListener('change', ()=>{ state.ps=+$('ps').value; load(); });
$('orderBy').addEventListener('change', ()=>{ state.orderBy=$('orderBy').value; load(); });
$('dir').addEventListener('change', ()=>{ state.dir=$('dir').value; load(); });
$('q').addEventListener('input', debounce(()=>{ state.q=$('q').value; state.page=1; load(); }, 300));
$('refresh').addEventListener('click', load);
$('sync').addEventListener('click', doSync);
$('save').addEventListener('click', saveEdit);
$('deleteBtn').addEventListener('click', ()=> doDelete(state.selected));
$('btnCancelar').addEventListener('click', ()=>{
  $('editForm').style.display='none';
  $('editInfo').style.display='block';
  document.querySelectorAll('#editForm input, #editForm select').forEach(el=> el.value='');
  state.selected=null;
});

/* ====== LOAD LIST ====== */
async function load(){
  try{
    const u = new URL(API_PANEL);
    u.searchParams.set("action","list");
    u.searchParams.set("page", state.page);
    u.searchParams.set("pageSize", state.ps);
    u.searchParams.set("search", state.q);
    u.searchParams.set("orderBy", state.orderBy);
    u.searchParams.set("orderDir", state.dir);

    const res = await fetch(u, { headers:{ "Accept":"application/json" }});
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    $('k_total').textContent = data?.stats?.total ?? 0;
    $('k_ok').textContent    = data?.stats?.aprobados ?? 0;
    $('k_bad').textContent   = data?.stats?.rechazados ?? 0;

    const rows = Array.isArray(data?.rows) ? data.rows : [];
    const tb = $('tbody'); tb.innerHTML='';

    rows.forEach(r=>{
      const num  = r['N° de Trámite'] || r.numeroTramite || '';
      const ev   = r['Evento Deportivo'] || r.evento || '';
      const pres = r['Presentado por'] || r.presentadoPor || '';
      const ci   = r['Cédula de Identidad'] || r.cedula || '';
      const femi = r['Fecha de Emisión'] || r.fechaEmision || '';
      const est  = r['Estado del Trámite'] || r.estado || '';
      const pdf  = r.PDF || r['URL PDF'] || r.PdfUrl || '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="clip" title="${safe(num)}">${safe(num)}</td>
        <td class="clip" title="${safe(ev)}">${safe(ev)}</td>
        <td class="clip" title="${safe(pres)}">${safe(pres)}</td>
        <td>${safe(ci)}</td>
        <td>${safe(femi)}</td>
        <td>${badge(est)}</td>
        <td>${pdf ? `<a href="${pdf}" target="_blank" title="Abrir PDF">${icon('open')}</a>` : ''}</td>
        <td style="display:flex;gap:.35rem;">
          <button class="icon" title="Editar" onclick="openRow(${r.__row})">${icon('edit')}</button>
          <button class="icon" title="Regenerar PDF" onclick="regen(${r.__row})">${icon('refresh')}</button>
          <button class="icon" title="Eliminar" onclick="doDelete(${r.__row})">${icon('trash')}</button>
        </td>`;
      tb.appendChild(tr);
    });

  }catch(err){
    console.error(err);
    Swal.fire("Error", err.message || "No se pudo cargar la lista", "error");
  }
}

/* ====== OPEN ROW ====== */
async function openRow(row){
  try{
    const u = new URL(API_PANEL);
    u.searchParams.set("action","get");
    u.searchParams.set("row", row);
    const rec = await (await fetch(u)).json();
    if (rec.error) throw new Error(rec.error);

    state.selected = rec.__row;
    state.pdfHeader = rec._pdfHeader || null;

    $('editInfo').style.display='none';
    $('editForm').style.display='block';

    $('f_evento').value        = rec['Evento Deportivo'] || rec.evento || '';
    $('f_presentadoPor').value = rec['Presentado por'] || rec.presentadoPor || '';
    $('f_cedula').value        = rec['Cédula de Identidad'] || rec.cedula || '';
    $('f_lugar').value         = rec['Lugar del Evento'] || rec.lugar || '';
    $('f_ciudad').value        = rec['Ciudad'] || rec.ciudad || '';
    $('f_provincia').value     = rec['Provincia'] || rec.provincia || '';

    // Fechas / horas: siempre llenas (corto), aunque en la hoja estén largas
    setDate('#f_fechaEvento',  rec.fechaEventoISO  ?? (rec['Fecha del Evento'] || rec.fechaEvento));
    setTime('#f_horaInicio',   rec.horaInicioISO   ?? (rec['Hora Inicio']     || rec.horaInicio));
    setTime('#f_horaFin',      rec.horaFinISO      ?? (rec['Hora Fin']        || rec.horaFin));
    setDate('#f_fechaEmision', rec.fechaEmisionISO ?? rec.FechaEmisionISO ?? (rec['Fecha de Emisión'] || rec.fechaEmision));

    $('f_aforo').value         = rec['Aforo'] || rec.aforo || '';
    $('f_estado').value        = rec['Estado del Trámite'] || rec.estado || '';
    $('f_PdfUrl').value        = rec.PDF || rec['URL PDF'] || rec.PdfUrl || '';
    $('f_Observaciones').value = rec.Observaciones || '';

    window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
  }catch(e){
    Swal.fire("Error", e.message || "No se pudo abrir el registro", "error");
  }
}

/* ====== SAVE ====== */
async function saveEdit(){
  if (!state.selected) return;
  const p = new URLSearchParams();
  p.set("action","update");
  p.set("__row", String(state.selected));

  // nombres EXACTOS según tu hoja
  p.set("Evento Deportivo", $('f_evento').value);
  p.set("Presentado por", $('f_presentadoPor').value);
  p.set("Cédula de Identidad", $('f_cedula').value);
  p.set("Lugar del Evento", $('f_lugar').value);
  p.set("Ciudad", $('f_ciudad').value);
  p.set("Provincia", $('f_provincia').value);
  p.set("Fecha del Evento", $('f_fechaEvento').value); // ISO -> backend lo guarda largo
  p.set("Hora Inicio", $('f_horaInicio').value);
  p.set("Hora Fin", $('f_horaFin').value);
  p.set("Aforo", $('f_aforo').value);
  p.set("Estado del Trámite", $('f_estado').value);
  p.set("Fecha de Emisión", $('f_fechaEmision').value); // ISO -> backend lo guarda largo
  p.set("Observaciones", $('f_Observaciones').value);
  if (state.pdfHeader) p.set(state.pdfHeader, $('f_PdfUrl').value);

  const out = await (await fetch(API_PANEL, {
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
    body: p.toString()
  })).json();

  if (!out.ok){ Swal.fire("Error","No se pudo guardar","error"); return; }
  Swal.fire("Guardado","Cambios aplicados","success");
  load();
}

/* ====== DELETE ====== */
async function doDelete(row){
  const target = row || state.selected;
  if (!target){ Swal.fire("Aviso","Selecciona un registro primero","info"); return; }
  const c = await Swal.fire({title:"¿Eliminar?",text:"Esta acción no se puede deshacer.",icon:"warning",showCancelButton:true,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"});
  if (!c.isConfirmed) return;

  const p = new URLSearchParams();
  p.set("action","delete");
  p.set("row", String(target));

  const out = await (await fetch(API_PANEL,{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
    body: p.toString()
  })).json().catch(()=>({}));

  if (!out || out.ok===false){ Swal.fire("Aviso","Eliminar no disponible.","warning"); return; }
  Swal.fire("Eliminado","Registro eliminado","success");
  state.selected=null; $('editForm').style.display='none'; $('editInfo').style.display='block';
  load();
}

/* ====== REGEN PDF ====== */
async function regen(row){
  try{
    const u = new URL(API_PANEL);
    u.searchParams.set("action","regen");
    u.searchParams.set("row", row);
    const d = await (await fetch(u)).json().catch(()=>({}));
    if (!d || d.ok===false){ Swal.fire("Aviso","No se pudo regenerar.","warning"); return; }
    if (d.pdf) window.open(d.pdf,"_blank");
    load();
  }catch(e){ Swal.fire("Error","No se pudo regenerar","error"); }
}

/* ====== SYNC ====== */
async function doSync(){
  try{
    const js = await (await fetch(API_FORM + "?action=sync")).json();
    Swal.fire("Sincronizado", `seq=${js.syncedTo??"-"} | next=${js.nextPreview??"-"}`, "success");
  }catch{ Swal.fire("Error","No se pudo sincronizar","error"); }
}

/* ====== Helpers de fechas/horas para inputs ====== */
function setDate(sel, v){
  const el = document.querySelector(sel);
  if (!el) return;
  const dt = parseDateAny(v);
  if (dt) el.valueAsDate = dt; else el.value = '';
}
function setTime(sel, v){
  const el = document.querySelector(sel);
  if (!el) return;
  const t = parseTimeAny(v);
  el.value = t || '';
}
function parseDateAny(v){
  if (!v && v !== 0) return null;
  if (v instanceof Date && !isNaN(v)) return new Date(v.getFullYear(), v.getMonth(), v.getDate());
  const s = String(v).trim();
  if (!s) return null;
  let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);       // yyyy-mm-dd
  if (m) return new Date(+m[1], +m[2]-1, +m[3]);
  m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/); // dd/mm/aaaa o dd-mm-aaaa
  if (m) return new Date(+m[3], +m[2]-1, +m[1]);
  m = s.match(/^(\d{1,2})\s+de\s+([a-záéíóúñ]+)\s+de\s+(\d{4})$/i); // 11 de mayo de 2025
  if (m){
    const meses = {enero:1,febrero:2,marzo:3,abril:4,mayo:5,junio:6,julio:7,agosto:8,septiembre:9,setiembre:9,octubre:10,noviembre:11,diciembre:12};
    const mo = meses[(m[2]||'').toLowerCase()];
    if (mo) return new Date(+m[3], mo-1, +m[1]);
  }
  const d = new Date(s);
  return isNaN(d) ? null : new Date(d.getFullYear(), d.getMonth(), d.getDate());
}
function parseTimeAny(v){
  if (!v && v !== 0) return '';
  const s = String(v).trim();
  if (!s || s === '--:--') return '';
  let m = s.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);
  if (m){
    const hh = ('0'+Math.max(0, Math.min(23, parseInt(m[1],10)))).slice(-2);
    const mm = ('0'+Math.max(0, Math.min(59, parseInt(m[2],10)))).slice(-2);
    return `${hh}:${mm}`;
  }
  const d = new Date(s);
  if (!isNaN(d)){
    const hh = ('0'+d.getHours()).slice(-2);
    const mm = ('0'+d.getMinutes()).slice(-2);
    return `${hh}:${mm}`;
  }
  return '';
}

/* INIT */
document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
